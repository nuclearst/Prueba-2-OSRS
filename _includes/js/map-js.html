{%- if site.data.theme.icons -%}{% assign icons = site.data.theme.icons %}{% else %}
{% assign cb_icons = site.pages | where: "name","cb-icons.svg" | first %}
{% assign icons = cb_icons.icons %}{%- endif -%}
{% if site.data.theme.map-child-objects == true %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{% else %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' | where_exp: 'item','item.parentid == nil' -%}
{% endif %}
{%- assign items = items | where_exp: 'item', 'item.objectid != nil' | where_exp: 'item','item.latitude' -%}
{%- assign fields = site.data.config-map -%}
<!-- Leaflet -->
<script src="{{ '/assets/lib/leaflet/leaflet.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/Leaflet.fullscreen.min.js' | relative_url }}"></script>
{% if site.data.theme.map-search == true %}<script src="{{ '/assets/lib/leaflet/fuse.min.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/leaflet.fusesearch.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-search == true and site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.freezable.js' | relative_url }}"></script>{% endif %}

<script>
(function(){
  /* Build map data (GeoJSON-like) from metadata */
  var geodata = { "type": "FeatureCollection", "features": [
    {% for item in items %}
    { "type":"Feature",
      "geometry":{ "type":"Point", "coordinates":[ {{ item.longitude | strip }}, {{ item.latitude | strip }} ] },
      "properties":{
        "title": {{ item.title | jsonify }},
        {% for f in fields %}{{ f.field | jsonify }}: {{ item[f.field] | jsonify }},{% endfor %}
        "id": {{ item.objectid | jsonify }},
        "creator": {{ item.creator | jsonify }},
        "location": {{ item.location | jsonify }},
        "date": {{ item.date | jsonify }},
        {% if item.youtubeid %}"youtube": {{ item.youtubeid | jsonify }}, {% endif %}
        "format": {{ item.format | jsonify }},
        {% if item.filename %}"image": "{{ '/objects/thumbs/' | relative_url | append: item.filename }}", {% endif %}
        {% if item.vimeoid %}"vimeo": {{ item.vimeoid | jsonify }}, {% endif %}
        "link": {{ item.objectid | jsonify }}
      }
    }{% unless forloop.last %}, {% endunless %}
    {% endfor %}
  ]};

  /* URL param to open a specific marker (?marker=objectid) */
  let url = new URL(window.location);
  var markerFilter = url.searchParams.get('marker') ? url.searchParams.get('marker') : "";

  /* Init map on image coordinates */
  var map = L.map('map', {
    crs: L.CRS.Simple,
    zoomControl: true,
    fullscreenControl: true
  });

  /* OSRS world image as basemap */
  var imgUrl = "{{ '/assets/osrs/osrs_world_map.png' | relative_url }}";
  var img = new Image();
  img.onload = function() {
    var w = img.naturalWidth || img.width;
    var h = img.naturalHeight || img.height;
    var imageBounds = [[0,0], [h, w]]; // top-left to bottom-right

    L.imageOverlay(imgUrl, imageBounds).addTo(map);
    map.setMaxBounds(imageBounds);
    map.fitBounds(imageBounds);

    {% if site.data.theme.map-cluster == true %}
    /* MarkerCluster con punto verde (singleMarkerMode) */
    var markers = L.markerClusterGroup({
      maxClusterRadius: 40,
      singleMarkerMode: true,
      spiderfyOnMaxZoom: true
    });
    {% endif %}

    /* === PARCHE coordenadas: fracción/porcentaje dentro del borde === */
    function toImageLatLng(lat, lng) {
      if (lat == null || lng == null || isNaN(lat) || isNaN(lng)) return null;
      var y = lat, x = lng;
      var aLat = Math.abs(lat), aLng = Math.abs(lng);
      if ((aLat <= 1 && aLng <= 1)) {
        y = Math.min(lat, 0.9999) * h;
        x = Math.min(lng, 0.9999) * w;
      } else if ((aLat <= 100 && aLng <= 100)) {
        y = (Math.min(lat, 99.9999) / 100.0) * h;
        x = (Math.min(lng, 99.9999) / 100.0) * w;
      } // else: píxeles
      y = Math.max(0, Math.min(h - 1, y));
      x = Math.max(0, Math.min(w - 1, x));
      return L.latLng(y, x);
    }

    /* Popup */
    function objectPopups(feature, layer) {
      feature.layer = layer;
      var itemHref = '{{ "/item.html" | relative_url }}?id=' + feature.properties.link;

      var thumbSrc;
      if (feature.properties.youtube) {
        thumbSrc = 'https://img.youtube.com/vi/' +  feature.properties.youtube + '/default.jpg';
      } else if (feature.properties.format && feature.properties.format.includes("image")) {
        thumbSrc = feature.properties.image ? feature.properties.image : '{{ "/assets/img/default.png" | relative_url }}';
      } else {
        thumbSrc = '{{ "/assets/img/default.png" | relative_url }}';
      }

      var metaData = '<ul class="list-unstyled">';
      {% for f in fields %}
      {% if f.popup == 'true' %}
      metaData += '<li><strong>{{ f.label }}:</strong> ' + (feature.properties[{{ f.field | jsonify }}] || '') + '</li>';
      {% endif %}
      {% endfor %}
      metaData += '</ul>';

      var popupText = `<div class="card map-popup h-100 border border-light-subtle rounded-1 overflow-hidden">
          <img class="card-img-top" src="${thumbSrc}" alt="">
          <div class="card-body">
            <h3 class="h5 card-title"><a href="${itemHref}">${feature.properties.title || '(sin título)'}</a></h3>
            ${metaData}
          </div>
        </div>`;
      layer.bindPopup(popupText);
    }

    /* Marcadores:
       - Si hay cluster -> L.marker (y cluster los pinta como punto verde en singleMarkerMode).
       - Si NO hay cluster -> L.circleMarker estilo verde. */
    function objectMarkers(feature/*, latlngIgnored*/) {
      var coords = feature.geometry && feature.geometry.coordinates ? feature.geometry.coordinates : null;
      var ll = coords ? toImageLatLng(coords[1], coords[0]) : null;
      if (!ll) return null;

      {% if site.data.theme.map-cluster == true %}
      var marker = L.marker(ll, { alt: feature.properties.title });
      markers.addLayer(marker);
      return marker;
      {% else %}
      return L.circleMarker(ll, {
        radius: 6,
        weight: 1,
        color: '#147a3c',
        fillColor: '#2ecc71',
        fillOpacity: 0.9
      });
      {% endif %}
    }

    /* Cargar features */
    var mapFeatures = L.geoJson(geodata, {
      onEachFeature: objectPopups,
      pointToLayer: objectMarkers,
      filter: function(feature) {
        return feature && feature.geometry && feature.geometry.coordinates &&
               feature.geometry.coordinates.length === 2 &&
               !isNaN(feature.geometry.coordinates[0]) && !isNaN(feature.geometry.coordinates[1]);
      }
    }){% if site.data.theme.map-cluster != true %}.addTo(map);{% else %};
    map.addLayer(markers);{% endif %}

    {% if site.data.theme.map-search == true %}
    /* Búsqueda (si está activa) */
    var options = {
      title: 'Buscar objetos del mapa',
      placeholder: 'Buscar...',
      threshold: 0.35,
      showInvisibleFeatures: true,
      position: 'topleft'
    };
    var fuseSearchCtrl = L.control.fuseSearch(options);
    map.addControl(fuseSearchCtrl);
    var props = ['id','title','creator','location','date'];
    mapFeatures.eachLayer(function(l){
      var f = l.feature;
      f.properties.index = mapFeatures.getLayers().indexOf(l);
      fuseSearchCtrl.indexFeatures(f, props);
    });
    fuseSearchCtrl.on('select', function(e) {
      var l = mapFeatures.getLayers()[e.feature.properties.index];
      if (l) { map.setView(l.getLatLng(), map.getZoom()); l.openPopup(); }
    });
    {% endif %}

    /* Abrir popup si ?marker=ID */
    if (markerFilter != "") {
      {% if site.data.theme.map-cluster == true %}
      markers.eachLayer(layer => {
        if (layer.feature.properties.id === markerFilter) {
          if (markers.getVisibleParent(layer)["_childCount"]) {
            markers.getVisibleParent(layer).spiderfy();
          }
          layer.openPopup();
        }
      });
      {% else %}
      mapFeatures.eachLayer(layer => {
        if (layer.feature.properties.id === markerFilter) {
          layer.openPopup();
        }
      });
      {% endif %}
    }

  }; // end img.onload

  img.src = imgUrl;

})();
</script>
