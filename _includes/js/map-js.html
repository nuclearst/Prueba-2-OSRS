---
layout: page
title: Map
permalink: /map.html
---

<!-- Estilos y contenedor -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css"/>
<style>
  #map{height:78vh;min-height:500px;width:100%;}
  /* Tooltip con imagen para el hover */
  .leaflet-tooltip.cb-tooltip{
    background:#fff;border:1px solid #d0d0d0;box-shadow:0 2px 12px rgba(0,0,0,.15);
    padding:.5rem .6rem;border-radius:.5rem;max-width:220px;
  }
  .leaflet-tooltip.cb-tooltip .title{font-weight:600;margin-bottom:.25rem;}
  .leaflet-tooltip.cb-tooltip img{max-width:200px;max-height:120px;display:block}
</style>
<div id="map"></div>

<!-- Librerías -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js"></script>

<!-- Código del mapa (embebido) -->
<script>
// --- Config de imagen (OSRS) ---
const IMAGE_WIDTH  = 8712;   // X
const IMAGE_HEIGHT = 4912;   // Y
const IMAGE_URL = "{{ '/assets/osrs/osrs_world_map.png' | relative_url }}";

// --- Utilidades ---
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function getParam(name){
  const m = new RegExp('[?&]'+name+'=([^&]+)').exec(location.search);
  return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : null;
}
function itemHref(r){
  const id = (r.objectid || r.id || "").toString().trim();
  if(!id) return "#";
  return "{{ '/item.html' | relative_url }}?id=" + encodeURIComponent(id);
}
function thumbUrl(r){
  // intenta campos comunes y hace fallback a /objects/ si no hay thumbs
  if(r.thumbnail && r.thumbnail!=="null") return r.thumbnail;
  if(r.image_thumb && r.image_thumb!=="null") return r.image_thumb;
  if(r.image_small && r.image_small!=="null") return r.image_small;
  if(r.image && r.image!=="null") return r.image;
  if(r.filename && r.filename!=="null") return "{{ '/objects/thumbs/' | relative_url }}"+r.filename;
  if(r.filename && r.filename!=="null") return "{{ '/objects/' | relative_url }}"+r.filename;
  return "";
}
function popupHtml(r){
  const t = r.title || r.label || "(Sin título)";
  const img = thumbUrl(r);
  const date = r.date? `<div><strong>Date:</strong> ${r.date}</div>`:"";
  const creator = r.creator? `<div><strong>Creator:</strong> ${r.creator}</div>`:"";
  const subjects = (r.subjects||r.subject)? `<div><strong>Subjects:</strong> ${r.subjects||r.subject}</div>`:"";
  const loc = r.location? `<div><strong>Location:</strong> ${r.location}</div>`:"";
  return `
    <div class="cb-popup">
      <div class="h5 mb-2">${t}</div>
      ${img?`<div class="mb-2"><img src="${img}" alt="" style="max-width:220px;max-height:140px;display:block;"/></div>`:""}
      ${date}${creator}${subjects}${loc}
      <a class="btn btn-sm btn-primary mt-2" href="${itemHref(r)}">View Item</a>
    </div>`;
}

// --- Cargar registros desde tu CSV (site.data[site.metadata]) ---
var records = [
{% assign data = site.data[site.metadata] %}
{% for i in data %}
  {
    "id": {{ i.id | jsonify }},
    "objectid": {{ i.objectid | jsonify }},
    "title": {{ i.title | jsonify }},
    "date": {{ i.date | jsonify }},
    "creator": {{ i.creator | jsonify }},
    "subjects": {{ i.subjects | default: i.subject | jsonify }},
    "location": {{ i.location | jsonify }},
    "latitude": {{ i.latitude | jsonify }},
    "longitude": {{ i.longitude | jsonify }},
    "thumbnail": {{ i.image_thumb | default: i.thumbnail | default: i.image_small | jsonify }},
    "image": {{ i.image | jsonify }},
    "filename": {{ i.filename | jsonify }}
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
];
records = records.filter(r=>{
  const hasLat = (r.latitude!==null && r.latitude!=="" && !isNaN(r.latitude));
  const hasLng = (r.longitude!==null && r.longitude!=="" && !isNaN(r.longitude));
  return hasLat && hasLng;
});

// --- Iniciar mapa ---
(function(){
  const el = document.getElementById('map');
  if(!el){ console.error('No #map'); return; }

  const bounds = [[0,0],[IMAGE_HEIGHT,IMAGE_WIDTH]]; // [[yMin,xMin],[yMax,xMax]]
  const map = L.map(el,{
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 4,
    zoomControl: true,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0,
    fullscreenControl: true  // <— botón de pantalla completa
  });

  // si el plugin no añadió el control, lo agregamos manualmente
  if (L.Control && L.Control.Fullscreen && !map.fullscreenControl) {
    L.control.fullscreen({ position: 'topleft' }).addTo(map);
  }

  L.imageOverlay(IMAGE_URL, bounds).addTo(map);
  map.fitBounds(bounds);

  const markerLayer = (L.markerClusterGroup)
    ? L.markerClusterGroup({spiderfyOnMaxZoom:true})
    : L.layerGroup();
  markerLayer.addTo(map);

  const latLngs = [];
  const markersById = {};

  records.forEach(r=>{
    const y = clamp(parseFloat(r.latitude), 0, IMAGE_HEIGHT);
    const x = clamp(parseFloat(r.longitude), 0, IMAGE_WIDTH);
    const m = L.marker([y,x], {title: r.title || r.id || ""});

    // --- Tooltip con imagen (hover) ---
    const thumb = thumbUrl(r);
    const tt = (thumb)
      ? `<div class="title">${r.title || ""}</div><img src="${thumb}" alt="">`
      : `<div class="title">${r.title || ""}</div>`;
    m.bindTooltip(tt, {direction:'top', sticky:true, opacity:0.95, className:'cb-tooltip'});

    // --- Popup completo (click) ---
    m.bindPopup(popupHtml(r), {maxWidth:320, autoPan:true, closeButton:true});

    markerLayer.addLayer(m);
    latLngs.push([y,x]);

    const key = (r.objectid || r.id || "").toString().trim();
    if(key) markersById[key] = m;
  });

  if(latLngs.length){
    const fb = L.latLngBounds(latLngs);
    map.fitBounds(fb.pad(0.15));
  }

  // Parámetros de URL
  const locParam = getParam("location");
  if(locParam){
    const p = locParam.split(",");
    if(p.length===2){
      const y = clamp(parseFloat(p[0]),0,IMAGE_HEIGHT);
      const x = clamp(parseFloat(p[1]),0,IMAGE_WIDTH);
      map.setView([y,x], Math.max(map.getZoom(),0));
    }
  }
  const markerParam = getParam("marker");
  if(markerParam && markersById[markerParam]){
    const t = markersById[markerParam];
    if(markerLayer.zoomToShowLayer){
      markerLayer.zoomToShowLayer(t, function(){
        t.openPopup(); map.panTo(t.getLatLng());
      });
    } else {
      t.openPopup(); map.panTo(t.getLatLng());
    }
  }

  console.log("Registros con coords:", records.length);
})();
</script>
