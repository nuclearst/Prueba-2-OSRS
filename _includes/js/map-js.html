{%- if site.data.theme.icons -%}{% assign icons = site.data.theme.icons %}{% else %}
{% assign cb_icons = site.pages | where: "name","cb-icons.svg" | first %}
{% assign icons = cb_icons.icons %}{%- endif -%}
{% if site.data.theme.map-child-objects == true %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{% else %}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' | where_exp: 'item','item.parentid == nil' -%}
{% endif %}
{%- assign items = items | where_exp: 'item', 'item.objectid != nil' | where_exp: 'item','item.latitude' -%}
{%- assign fields = site.data.config-map -%}
<!-- load leaflet dependencies -->
<script src="{{ '/assets/lib/leaflet/leaflet.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/Leaflet.fullscreen.min.js' | relative_url }}"></script>
{% if site.data.theme.map-search == true %}<script src="{{ '/assets/lib/leaflet/fuse.min.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/leaflet.fusesearch.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.js' | relative_url }}"></script>{% endif %}
{% if site.data.theme.map-search == true and site.data.theme.map-cluster == true %}<script src="{{ '/assets/lib/leaflet/leaflet.markercluster.freezable.js' | relative_url }}"></script>{% endif %}

<script>
(function(){
    /* assemble GeoJSON-like data from metadata */
    var geodata = { "type": "FeatureCollection", "features": [ 
    {% for item in items %}
    { "type":"Feature", "geometry":{ "type":"Point", "coordinates":[ {{ item.longitude | strip }},{{ item.latitude | strip }} ] }, "properties":
      { "title": {{ item.title | jsonify }}, 
        {% for f in fields %}{{ f.field | jsonify }}: {{ item[f.field] | jsonify }}, {% endfor %}
        "id": {{ item.objectid | jsonify }}, "creator": {{ item.creator | jsonify }}, "location": {{ item.location | jsonify }}, "date": {{ item.date | jsonify }},
        {% if item.youtubeid %} "youtube": {{ item.youtubeid | jsonify }}, {% endif %}
        "format": {{ item.format | jsonify }}, {% if  item.filename %} "image": "{{ '/objects/thumbs/' | relative_url | append: item.filename }}", {% endif %}
        {% if  item.vimeoid %} "vimeo": {{ item.vimeoid | jsonify }}, {% endif %}
        "link": {{ item.objectid | jsonify }}
      } }{% unless forloop.last %}, {% endunless %}{% endfor %}
    ]};

    /* URL params for focusing on a marker */
    let url = new URL(window.location);
    var markerFilter = url.searchParams.get('marker') ? url.searchParams.get('marker') : "";

    /* Create the map with a simple CRS for image coordinates */
    var map = L.map('map', {
        crs: L.CRS.Simple,
        zoomControl: true,
        fullscreenControl: true
    });

    /* Load the OSRS world map image and overlay it */
    var imgUrl = "{{ '/assets/osrs/osrs_world_map.png' | relative_url }}";
    var img = new Image();
    img.onload = function() {
        var w = img.naturalWidth || img.width;
        var h = img.naturalHeight || img.height;
        var imageBounds = [[0,0], [h, w]]; // top-left to bottom-right in simple CRS

        /* Add image overlay as the basemap */
        var imageLayer = L.imageOverlay(imgUrl, imageBounds).addTo(map);

        /* Configure map view/limits */
        map.setMaxBounds(imageBounds);
        map.fitBounds(imageBounds);

        {% if site.data.theme.map-cluster == true %}
        /* cluster group if enabled */
        var markers = L.markerClusterGroup({ maxClusterRadius: 40 });
        {% endif %}

        /* Helper: convert metadata (latitude, longitude) -> image coords (y, x) */
        function toImageLatLng(lat, lng) {
            if (lat == null || lng == null || isNaN(lat) || isNaN(lng)) return null;

            var y = lat;
            var x = lng;

            /* Heuristics:
               - If values are between 0 and 1, treat as fractions of image size.
               - Else if between -1 and 1, also treat as fractions.
               - Else if between 0 and 100 (or -100..100), treat as percentages.
               - Else assume they are already in image pixels.
            */
            var aLat = Math.abs(lat);
            var aLng = Math.abs(lng);
            if ((aLat <= 1 && aLng <= 1)) {
                y = lat * h;
                x = lng * w;
            } else if ((aLat <= 100 && aLng <= 100)) {
                y = (lat / 100.0) * h;
                x = (lng / 100.0) * w;
            } // else: treat as pixels already

            return L.latLng(y, x);
        }

        /* popup builder */
        function objectPopups(feature, layer) {
            feature.layer = layer;
            var itemHref = '{{ "/item.html" | relative_url }}?id=' + feature.properties.link;
            var thumbSrc;
            if (feature.properties.youtube) {
                thumbSrc = 'https://img.youtube.com/vi/' +  feature.properties.youtube + '/default.jpg';
            } else if (feature.properties.format && feature.properties.format.includes("image")) {
                thumbSrc = feature.properties.image ? feature.properties.image : '{{ "/assets/img/default.png" | relative_url }}';
            } else {
                thumbSrc = '{{ "/assets/img/default.png" | relative_url }}';
            }
            var metaData = '<ul class="list-unstyled">';
            {% for f in fields %} 
            {% if f[2] == "true" %}metaData = metaData + '<li><strong>{{ f[1] }}:</strong> ' + (feature.properties[{{ f.field | jsonify }}] || '') + '</li>';{% endif %}
            {% endfor %}
            metaData = metaData + '</ul>';
            var popupText = `<div class="card map-popup h-100 border border-light-subtle rounded-1 overflow-hidden">
                <img class="card-img-top" src="${thumbSrc}" alt="">
                <div class="card-body">
                    <h3 class="h5 card-title"><a href="${itemHref}">${feature.properties.title || '(sin t√≠tulo)'}</a></h3>
                    ${metaData}
                </div>
            </div>`;
            layer.bindPopup(popupText);
        }

        /* place markers, transforming lat/lon into image coordinates */
        function objectMarkers(feature/*, latlngIgnored*/) {
            var coords = feature.geometry && feature.geometry.coordinates ? feature.geometry.coordinates : null;
            var ll = coords ? toImageLatLng(coords[1], coords[0]) : null;
            if (!ll) return null;
            var marker = L.marker(ll, { alt: feature.properties.title });
            {% if site.data.theme.map-cluster == true %}markers.addLayer(marker);{% endif %}
            return marker;
        }

        var mapFeatures = L.geoJson(geodata, {
            onEachFeature: objectPopups,
            pointToLayer: objectMarkers,
            filter: function(feature) {
                /* only render items that have coordinates */
                return feature && feature.geometry && feature.geometry.coordinates &&
                       feature.geometry.coordinates.length === 2 &&
                       !isNaN(feature.geometry.coordinates[0]) && !isNaN(feature.geometry.coordinates[1]);
            }
        }){% if site.data.theme.map-cluster != true %}.addTo(map);{% else %};
        map.addLayer(markers);{% endif %}

        {% if site.data.theme.map-search == true %}
        /* add leaflet-fusesearch (works on popups/layers) */
        var options = {
            title: 'Buscar objetos del mapa',
            placeholder: 'Buscar...',
            threshold: 0.35,
            showInvisibleFeatures: true,
            position: 'topleft'
        };
        var fuseSearchCtrl = L.control.fuseSearch(options);
        map.addControl(fuseSearchCtrl);
        var props = ['id','title','creator','location','date'];
        mapFeatures.eachLayer(function(l){
            var f = l.feature;
            f.properties.index = mapFeatures.getLayers().indexOf(l);
            fuseSearchCtrl.indexFeatures(f, props);
        });
        fuseSearchCtrl.on('select', function(e) {
            var l = mapFeatures.getLayers()[e.feature.properties.index];
            if (l) {
                map.setView(l.getLatLng(), map.getZoom());
                l.openPopup();
            }
        });
        {% endif %}

        /* Show a popup if id passed in URL (?marker=objectid) */
        if (markerFilter != "") {
            {% if site.data.theme.map-cluster == true %}
            markers.eachLayer(layer => {
                if (layer.feature.properties.id === markerFilter) {
                    if (markers.getVisibleParent(layer)["_childCount"]) {
                        markers.getVisibleParent(layer).spiderfy();
                    }
                    layer.openPopup();
                }
            });
            {% else %}
            mapFeatures.eachLayer(layer => {
                if (layer.feature.properties.id === markerFilter) {
                    layer.openPopup();
                }
            });
            {% endif %}
        }

    }; // end img.onload

    img.src = imgUrl;

})();
</script>
