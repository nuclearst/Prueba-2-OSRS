<!-- Asegura altura visible del div #map -->
<style>
  #map { height: 70vh; }
</style>

{%- comment -%} Íconos del theme (igual que tu código) {%- endcomment -%}
{%- if site.data.theme.icons -%}
  {% assign icons = site.data.theme.icons %}
{%- else -%} 
  {% assign cb_icons = site.pages | where: "name","cb-icons.svg" | first %}
  {% assign icons = cb_icons.icons %}
{%- endif -%}

{%- comment -%} Items (igual que tu código base) {%- endcomment -%}
{% if site.data.theme.map-child-objects == true %}
  {%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
{% else %}
  {%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' | where_exp: 'item','item.parentid == nil' -%}
{% endif %}

{%- comment -%}
  Filtramos a los que tengan coordenadas (usaremos latitude/longitude como Y/X en píxeles)
{%- endcomment -%}
{%- assign items = items | where_exp: 'item', 'item.objectid != nil' | where_exp: 'item','item.latitude and item.longitude' -%}

{%- assign fields = site.data.config-map -%}

<!-- Librerías Leaflet y plugins -->
<script src="{{ '/assets/lib/leaflet/leaflet.js' | relative_url }}"></script>
<script src="{{ '/assets/lib/leaflet/Leaflet.fullscreen.min.js' | relative_url }}"></script>
{% if site.data.theme.map-search == true %}
  <script src="{{ '/assets/lib/leaflet/fuse.min.js' | relative_url }}"></script>
  <script src="{{ '/assets/lib/leaflet/leaflet.fusesearch.js' | relative_url }}"></script>
{% endif %}
{% if site.data.theme.map-cluster == true %}
  <script src="{{ '/assets/lib/leaflet/leaflet.markercluster.js' | relative_url }}"></script>
  {% if site.data.theme.map-search == true %}
  <script src="{{ '/assets/lib/leaflet/leaflet.markercluster.freezable.js' | relative_url }}"></script>
  {% endif %}
{% endif %}

<script>
(function(){

  /* =========================
     1) CONFIG: imagen del OSRS
     ========================= */
  // ¡OJO! Aquí va la ruta que diste:
  const OSRS_IMAGE_URL = '{{ "/assets/osrs/osrs_world_map.png" | relative_url }}';

  /* =========================
     2) GEODATA (latitude/longitude como y/x en píxeles)
     ========================= */
  // GeoJSON con tus ítems. IMPORTANTE:
  //   coordinates = [X, Y] = [longitude, latitude] (pero son píxeles, NO grados)
  var geodata = { "type": "FeatureCollection", "features": [ 
    {% for item in items %}
    { "type":"Feature",
      "geometry":{ "type":"Point", "coordinates":[{{ item.longitude | strip }}, {{ item.latitude | strip }}] },
      "properties":{
        "title": {{ item.title | jsonify }},
        {% for f in fields %}{{ f.field | jsonify }}: {{ item[f.field] | jsonify }},{% endfor %}
        {% if item.youtubeid %} "youtube": {{ item.youtubeid | jsonify }}, {% endif %}
        "format": {{ item.format | jsonify }},
        {% if  item.filename contains '/' %}"filename": "{{ item.filename }}" {% else %}"filename":{{ '/objects/' | relative_url | append: item.filename | jsonify }}{% endif %},
        "link": "{% if item.parentid %}{{ item.parentid }}#{{ item.objectid }}{% else %}{{ item.objectid }}{% endif %}",
        "id": {{ item.objectid | jsonify }}
      }
    }{% unless forloop.last %}, {% endunless %}{% endfor %}
  ]};

  /* =========================
     3) URL params (?location=x,y ; ?marker=id)
     ========================= */
  const url = new URL(window.location);
  const locParam = url.searchParams.get('location'); // ahora espera "x,y" en píxeles
  const markerFilter = url.searchParams.get('marker') || "";

  /* =========================
     4) Inicia Leaflet en CRS.Simple (coordenadas planas)
     ========================= */
  var map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 5,
    zoomControl: true
  });
  if (L.Control.Fullscreen) map.addControl(new L.Control.Fullscreen());

  // Cargamos la imagen para obtener dimensiones reales y fijar bounds:
  const baseImg = new Image();
  baseImg.src = OSRS_IMAGE_URL;
  baseImg.onload = function () {
    const W = baseImg.naturalWidth;
    const H = baseImg.naturalHeight;

    // Bounds del lienzo de la imagen: [[y0,x0],[y1,x1]] = [[0,0],[alto,ancho]]
    const bounds = [[0, 0], [H, W]];

    // Capa base única (no tile servers)
    const osrsBase = L.imageOverlay(OSRS_IMAGE_URL, bounds, { interactive: false }).addTo(map);
    L.control.layers({ "OSRS World Map": osrsBase }, {}).addTo(map);

    // Centrado inicial. Si ?location=x,y, usamos [y,x] (Leaflet lat,lng)
    let initialCenter = null, mapZoom = 0;
    if (locParam) {
      const parts = locParam.split(',').map(Number);
      if (parts.length === 2 && parts.every(Number.isFinite)) {
        initialCenter = [parts[1], parts[0]];
        mapZoom = 2;
      }
    }
    if (initialCenter) map.setView(initialCenter, mapZoom);
    else map.fitBounds(bounds);

    /* =========================
       5) Buscador (si el theme lo tiene activo)
       ========================= */
    {% if site.data.theme.map-search == true %}
    var options = {
      title: 'Search Map Items',
      locationholder: 'Search map items...',
      threshold: {{ site.data.theme.map-search-fuzziness | default: 0.35 }},
      showResultFct: function(feature, container) {
        var result = `<strong>${feature.properties.title}</strong><br>`;
        {% for f in fields %}
        if (feature.properties[{{ f.field | jsonify }}]) { result += feature.properties[{{ f.field | jsonify }}] + `<br>`; }
        {% endfor %}
        container.innerHTML = result;
      }
    };
    var searchCtrl = L.control.fuseSearch(options);
    searchCtrl.addTo(map);
    searchCtrl.indexFeatures(geodata.features, {{ fields | where: 'search','true' | map: 'field' | unshift: 'title' | jsonify }});
    {% endif %}

    /* =========================
       6) Cluster (si está activo)
       ========================= */
    {% if site.data.theme.map-cluster == true %}
    var markers = L.markerClusterGroup({
      maxClusterRadius: {{ site.data.theme.map-cluster-radius | default: 15 }},
      singleMarkerMode: true,
      iconCreateFunction: function(cluster) {
        var childCount = cluster.getChildCount();
        var csize = childCount < 10 ? 'small' : (childCount < 100 ? 'medium' : 'large');
        var c = ' marker-cluster-' + csize;
        return new L.DivIcon({
          html: '<div><span class="visually-hidden">' + csize +' cluster of </span><span>' + childCount + '</span><span class="visually-hidden"> items</span></div>',
          className: 'marker-cluster' + c,
          iconSize: new L.Point(40, 40)
        });
      }
      {% if site.data.theme.map-search == true %}, removeOutsideVisibleBounds: false{% endif %}
    });
    {% endif %}

    /* =========================
       7) Popups (igual que tu tema)
       ========================= */
    function objectPopups(feature, layer) {
      {% if site.data.theme.map-search == true %} feature.layer = layer; {% endif %}
      var itemHref = '{{ "/item.html" | relative_url }}?id=' + feature.properties.link;

      var thumbSrc;
      if (feature.properties.youtube) {
        thumbSrc = 'https://img.youtube.com/vi/' +  feature.properties.youtube + '/default.jpg';
      } else if (feature.properties.format && feature.properties.format.includes("image")) {
        thumbSrc = feature.properties.filename;
      } else if (feature.properties.format && feature.properties.format.includes("audio")) {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-audio }}.svg';
      } else if (feature.properties.format && feature.properties.format.includes("video")) {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-video }}.svg'; 
      } else if (feature.properties.format && feature.properties.format.includes("pdf")) {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-pdf }}.svg';
      } else if (feature.properties.format && feature.properties.format.includes("compound")) {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-compound-object }}.svg';  
      } else if (feature.properties.format && feature.properties.format.includes("multiple")) {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-multiple }}.svg';        
      } else {
        thumbSrc = '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-default }}.svg';
      }

      var popupTemplate = '<h2 class="h4"><a class="text-dark" href="' + itemHref + '">' +
        feature.properties.title + '</a></h2><div class="text-center"><a href="' + itemHref +
        '" ><img class="map-thumb img-thumb" src="' +  thumbSrc + '" alt="item thumbnail"></a></div><p>';

      {% for f in fields %}{% if f.display_name %}
      if (feature.properties[{{ f.field | jsonify }}]) {
        popupTemplate += '<strong>{{ f.display_name }}:</strong> ' + feature.properties[{{ f.field | jsonify }}] + '<br>';
      }
      {% endif %}{% endfor %}

      popupTemplate += '</p><div class="text-center"><a class="btn btn-light" href="' + itemHref + '" >View Item</a></div>';
      layer.bindPopup(popupTemplate);
    }

    /* =========================
       8) Marcadores desde GeoJSON
       ========================= */
    function objectMarkers(feature, latlng) {
      // Leaflet ya convierte [x,y] -> L.latLng(y,x) en CRS.Simple.
      var marker = L.marker(latlng, { alt: feature.properties.title });
      {% if site.data.theme.map-cluster == true %}markers.addLayer(marker);{% endif %}
      return marker;
    }

    var mapFeatures = L.geoJson(geodata, {
      onEachFeature: objectPopups,
      pointToLayer: objectMarkers
    })
    {% if site.data.theme.map-cluster != true %}.addTo(map);{% else %};
      map.addLayer(markers);
    {% endif %}

    /* =========================
       9) Auto-encuadre y ?marker
       ========================= */
    {% if site.data.theme.auto-center-map == true %}
    if (!locParam) {
      const featureBounds = mapFeatures.getBounds();
      if (featureBounds?.isValid()) map.fitBounds(featureBounds);
    }
    {% endif %}

    if (markerFilter) {
      {% if site.data.theme.map-cluster == true %}
      markers.eachLayer(layer => {
        if (layer.feature && layer.feature.properties.id === markerFilter) {
          if (markers.getVisibleParent(layer)["_childCount"]) {
            markers.getVisibleParent(layer).spiderfy();
          }
          layer.openPopup();
        }
      });
      {% else %}
      mapFeatures.eachLayer(layer => {
        if (layer.feature && layer.feature.properties.id === markerFilter) layer.openPopup();
      });
      {% endif %}
    }

    /* =========================
       10) Ayuda para capturar x,y
       ========================= */
    const coordBox = L.control({position:'bottomleft'});
    coordBox.onAdd = function() {
      const div = L.DomUtil.create('div','leaflet-bar');
      div.style.padding='6px 8px';
      div.style.background='rgba(255,255,255,.9)';
      div.style.font='12px/1.2 monospace';
      div.innerHTML = 'x,y: —';
      this._div = div; return div;
    };
    coordBox.addTo(map);
    map.on('click', (e) => {
      // En CRS.Simple: lat=Y, lng=X (píxeles relativos a la esquina sup-izq de la imagen)
      const x = Math.round(e.latlng.lng), y = Math.round(e.latlng.lat);
      coordBox._div.innerHTML = 'x,y: ' + x + ',' + y;
    });
  };

  baseImg.onerror = function () {
    console.error("No se pudo cargar la imagen del mapa:", OSRS_IMAGE_URL);
  };

})();
</script>

