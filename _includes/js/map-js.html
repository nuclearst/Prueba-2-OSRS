/* ===== CollectionBuilder-GH — Map (OSRS pixels) ===========================
   Requiere Leaflet y (opcional) Leaflet.markercluster cargados en map.html
   Se dibuja sobre una imagen (CRS.Simple) con coordenadas en píxeles.
   - Imagen base: 8712x4912 px (OSRS world map)
   - Soporta ?location=LAT,LNG y ?marker=ID
   - Vista previa al pasar el cursor; botón "View Item" corrige a item.html?id=
   ======================================================================= */

// ---------- Config de imagen ----------
const IMAGE_WIDTH  = 8712; // X
const IMAGE_HEIGHT = 4912; // Y
const IMAGE_URL = "{{ '/assets/osrs/osrs_world_map.png' | relative_url }}";

// ---------- Utilidades ----------
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function getParam(name){
  const m = new RegExp('[?&]' + name + '=([^&]+)').exec(location.search);
  return m ? decodeURIComponent(m[1].replace(/\+/g, ' ')) : null;
}

function itemHref(r){
  const id = (r.objectid || r.id || "").toString().trim();
  if(!id) return "#";
  return "{{ '/item.html' | relative_url }}?id=" + encodeURIComponent(id);
}

function thumbUrl(r){
  // intenta varios campos comunes de CollectionBuilder; si no, usa filename en /objects/thumbs/
  if (r.thumbnail && r.thumbnail !== "null") return r.thumbnail;
  if (r.image && r.image !== "null") return r.image;
  if (r.image_small && r.image_small !== "null") return r.image_small;
  if (r.image_thumb && r.image_thumb !== "null") return r.image_thumb;
  if (r.filename && r.filename !== "null") return "{{ '/objects/thumbs/' | relative_url }}" + r.filename;
  return "";
}

function popupHtml(r){
  const t = (r.title || r.label || "(Sin título)");
  const img = thumbUrl(r);
  const date = r.date ? `<div><strong>Date:</strong> ${r.date}</div>` : "";
  const creator = r.creator ? `<div><strong>Creator:</strong> ${r.creator}</div>` : "";
  const subjects = (r.subjects || r.subject) ? `<div><strong>Subjects:</strong> ${r.subjects || r.subject}</div>` : "";
  const loc = r.location ? `<div><strong>Location:</strong> ${r.location}</div>` : "";
  const link = `<a class="btn btn-sm btn-primary mt-2" href="${itemHref(r)}">View Item</a>`;

  return `
    <div class="cb-popup">
      <div class="h5 mb-2">${t}</div>
      ${img ? `<div class="mb-2"><img src="${img}" alt="" style="max-width:220px; max-height:140px; display:block;"/></div>` : ``}
      ${date}${creator}${subjects}${loc}
      ${link}
    </div>
  `;
}

// ---------- Datos (inyecta desde Jekyll / CSV) ----------
var records = [
{% assign data = site.data[site.metadata] %}
{% for i in data %}
  {
    "id": {{ i.id | jsonify }},
    "objectid": {{ i.objectid | jsonify }},
    "title": {{ i.title | jsonify }},
    "date": {{ i.date | jsonify }},
    "creator": {{ i.creator | jsonify }},
    "subjects": {{ i.subjects | default: i.subject | jsonify }},
    "location": {{ i.location | jsonify }},
    "latitude": {{ i.latitude | jsonify }},
    "longitude": {{ i.longitude | jsonify }},
    "thumbnail": {{ i.image_thumb | default: i.thumbnail | default: i.image_small | jsonify }},
    "image": {{ i.image | jsonify }},
    "filename": {{ i.filename | jsonify }}
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
];

// Filtra solo los que tienen coordenadas válidas o al menos numéricas
records = records.filter(function(r){
  const hasLat = (r.latitude !== null && r.latitude !== "" && !isNaN(r.latitude));
  const hasLng = (r.longitude !== null && r.longitude !== "" && !isNaN(r.longitude));
  return hasLat && hasLng;
});

// ---------- Iniciar mapa ----------
(function(){
  const el = document.getElementById('map') || document.getElementById('cb-map');
  if(!el || !window.L){
    console.warn("Map element or Leaflet not found.");
    return;
  }

  const bounds = [[0,0], [IMAGE_HEIGHT, IMAGE_WIDTH]]; // [[yMin,xMin],[yMax,xMax]]

  const map = L.map(el, {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 4,
    zoomControl: true,
    attributionControl: false,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
  });

  // Capa base: imagen del mundo
  L.imageOverlay(IMAGE_URL, bounds).addTo(map);
  map.fitBounds(bounds);

  // Capa de marcadores (cluster si existe la lib)
  const useClusters = !!L.markerClusterGroup;
  const markerLayer = useClusters ? L.markerClusterGroup({ spiderfyOnMaxZoom: true }) : L.layerGroup();
  markerLayer.addTo(map);

  // Agregar marcadores
  const markersById = {}; // para abrir por ?marker=id
  const latLngs = [];

  records.forEach(function(r){
    // coordenadas en píxeles Y (lat), X (lng) y clamp al tamaño de la imagen
    const y = clamp(parseFloat(r.latitude), 0, IMAGE_HEIGHT);
    const x = clamp(parseFloat(r.longitude), 0, IMAGE_WIDTH);

    const m = L.marker([y, x], { title: (r.title || r.id || "") });

    m.bindPopup(popupHtml(r), { maxWidth: 320, autoPan: true, autoClose: true, closeButton: true });

    // Vista previa al pasar el cursor
    m.on('mouseover', function(){ m.openPopup(); });
    m.on('mouseout', function(){ /* dejar el popup; se cierra al hacer click fuera */ });

    markerLayer.addLayer(m);
    latLngs.push([y, x]);

    const key = (r.objectid || r.id || "").toString().trim();
    if(key){ markersById[key] = m; }
  });

  // Ajusta vista a marcadores si existen
  if(latLngs.length){
    const fb = L.latLngBounds(latLngs);
    map.fitBounds(fb.pad(0.15));
  }

  // --------- Parámetros de URL: location y marker ----------
  const locParam = getParam("location");
  if(locParam){
    const parts = locParam.split(",");
    if(parts.length === 2){
      const y = clamp(parseFloat(parts[0]), 0, IMAGE_HEIGHT);
      const x = clamp(parseFloat(parts[1]), 0, IMAGE_WIDTH);
      map.setView([y, x], Math.max(map.getZoom(), 0));
    }
  }

  const markerParam = getParam("marker");
  if(markerParam && markersById[markerParam]){
    const target = markersById[markerParam];
    if(useClusters){
      markerLayer.zoomToShowLayer(target, function(){
        target.openPopup();
        map.panTo(target.getLatLng());
      });
    }else{
      target.openPopup();
      map.panTo(target.getLatLng());
    }
  }

})();
