{%- if site.data.theme.icons -%}{% assign icons = site.data.theme.icons %}{% else %}
{% assign cb_icons = site.pages | where: "name","cb-icons.svg" | first %}
{% assign icons = cb_icons.icons %}{%- endif -%}
{%- assign fields = site.data.config-metadata -%}
{%- assign stubs = site.data.config-nav | map: 'stub' | join: ';' -%}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
<script>
/* add item data */
var cb_items = [ 
    {%- for item in items -%}
    { "objectid": {{ item.objectid | jsonify }}, {% if item.parentid %}"parentid": {{ item.parentid | jsonify }}, {% endif %}"title": {{ item.title | jsonify }}, "date": {{ item.date | jsonify }}, "creator": {{ item.creator | jsonify }}, "subject": {{ item.subject | jsonify }}, "location": {{ item.location | jsonify }}, "format": {{ item.format | jsonify }}, "type": {{ item.type | jsonify }}, "description": {{ item.description | jsonify }}, "source": {{ item.source | jsonify }}, "language": {{ item.language | jsonify }}, "rights": {{ item.rights | jsonify }}, "rightsstatement": {{ item.rightsstatement | jsonify }}, "identifier": {{ item.identifier | jsonify }}, "coverage": {{ item.coverage | jsonify }}, "publisher": {{ item.publisher | jsonify }}, "contributor": {{ item.contributor | jsonify }}, "relation": {{ item.relation | jsonify }}, "transcription": {{ item.transcription | jsonify }}, "link": {{ item.link | jsonify }}, "youtubeid": {{ item.youtubeid | jsonify }}, "vimeoid": {{ item.vimeoid | jsonify }}, "iiif_base": {{ item.iiif_base | jsonify }}, "citation": {{ item.citation | jsonify }}, "filename": {{ item.filename | jsonify }}, "image_small": {{ item.image_small | jsonify }}, "image_thumb": {{ item.image_thumb | jsonify }}, "image_large": {{ item.image_large | jsonify }}, "image_full": {{ item.image_full | jsonify }}, "image_iiif": {{ item.image_iiif | jsonify }}, "image_width": {{ item.image_width | jsonify }}, "image_height": {{ item.image_height | jsonify }}, "audio": {{ item.audio | jsonify }}, "video": {{ item.video | jsonify }}, "pdf": {{ item.pdf | jsonify }}, "external_id": {{ item.external_id | jsonify }}, "latitude": {{ item.latitude | jsonify }}, "longitude": {{ item.longitude | jsonify }}, "subject1": {{ item.subject1 | jsonify }}, "subject2": {{ item.subject2 | jsonify }}, "subject3": {{ item.subject3 | jsonify }}, "subject4": {{ item.subject4 | jsonify }}, "subject5": {{ item.subject5 | jsonify }}, "collection": {{ item.collection | jsonify }}, "featured": {{ item.featured | jsonify }}, "search_string": {{ item.search_string | jsonify }}, "sort_string": {{ item.sort_string | jsonify }} }{% unless forloop.last %}, {% endunless %}
    {% endfor %}
];

/* function to find links to objects from filename field */ 
function findFileLink(record) {
    if (record.youtubeid) {
        return "https://youtu.be/" + record.youtubeid;
    } else if (record.vimeoid) {
        return "https://vimeo.com/" + record.vimeoid;
    } else if (record.filename) {
        let filename = record.filename;
        if (filename.includes("http")) {
            return filename;
        } else {
            return "{{ '/objects/' | relative_url }}" + filename;
        }
    } else {
        return "";
    }
}

/* find item id in query string */
let url = new URL(window.location);
var itemPageId = url.searchParams.get('id') ? url.searchParams.get('id') : cb_items[0].objectid;

/* prepare arrays for display */
var itemsToDisplay = [];
var compoundObjects = [];
var itemImage = "";
var itemLink = "";
var itemDownload = "";
var compoundDownload = "";

/* function to generate item page */
function generateItem(record) {
    /* identify compound objects */
    var hasChildren = cb_items.findIndex( item => item.parentid === record.objectid );
    var hasParent = record.parentid ? true : false;
    
    /* add children, siblings, and parent compound object arrays */
    if ( hasChildren != -1 && !hasParent) {
        compoundObjects = cb_items.filter( item => item.parentid ? item.parentid === record.objectid : "" );
        compoundObjects.splice(0, 0, record);
    } else if ( hasParent ) {
        compoundObjects = cb_items.filter( item => item.parentid ? item.parentid === record.parentid : "" );
        let parent = cb_items.find( item => item.objectid === record.parentid );
        compoundObjects.splice(0, 0, parent);
    }

    /* function to add download, timeline, and map links */
    function addButtons(item) {
        itemLink = '<div class="btn-group" role="group" aria-label="Item options">'
        {% if stubs contains "timeline" %}
        /* add link to view on timeline */
        if (item.date) {
            var itemYear;
            var dateExtract = new Date(Date.parse(item.date));
            if ( dateExtract.getFullYear() > 0 ) {
                itemYear = dateExtract.getFullYear();
            } else {
                itemYear = item.date;
            }
            var timelineButton = '<a href="{{ "/timeline.html" | relative_url }}?date=' + itemYear + '" class="btn btn-outline-primary">View on Timeline</a>';
            /* add timeline link to children only if specified in theme.yml */
            {% if site.data.theme.timeline-child-objects == true %}
                itemLink += timelineButton;
            {% else %}
                if (item === record) { itemLink += timelineButton; }
            {% endif %}
        }
        {%- endif -%}
        {% if stubs contains "map" %}
        /* add link to view on map */
        var itemMarker = item.parentid ? item.parentid : itemPageId;
        var mapButton = '<a href="{{ "/map.html" | relative_url }}?location=' + item.latitude + ',' + item.longitude + '&marker=' + itemMarker + '" class="btn btn-outline-primary">View on Map</a>';
        if (item.latitude && item.longitude) {
            /* add map link to children only if specified in theme.yml */
            {% if site.data.theme.map-child-objects == true %}
                itemLink += mapButton;
            {% else %}
                if (item === record) { itemLink += mapButton; }
            {% endif %}
        }
        {%- endif -%}
        /* add download link */
        itemDownload = findFileLink(item) != "" ? '<a href="' + findFileLink(item) + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download Object</a>' : '';
        /* add download dropdown for compound objects */
        compoundDownload = '<div class="btn-group" role="group"><button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Download</button> <ul class="dropdown-menu">';
        if (compoundObject.length > 0) {
            for (let i = 0; i < compoundObject.length; i++) {
                var fileLink = findFileLink(compoundObject[i]);
                if (fileLink != "") {
                    var dl = '<li><a class="dropdown-item" href="' + fileLink + '" target="_blank" rel="noopener">Download ' + (i+1) + '</a></li>';
                    compoundDownload += dl;
                }
            }
        }
        compoundDownload += '</ul></div>';
        itemLink += item.format.includes('compound_object') || item.format.includes('multiple') ? compoundDownload : itemDownload;
        itemLink += '</div>'
    };

    /* determine item format and add display and download links accordingly */
    function addItem(item) {
        var itemDisplay;
        {% if site.data.theme.item-embed == true %}
            if (item.youtubeid) {
                itemDisplay = '<div class="ratio ratio-16x9"><iframe src="https://www.youtube.com/embed/' + item.youtubeid + '" allow="autoplay; encrypted-media" allowfullscreen class="embed-responsive-item"></iframe></div>';
                itemDownload = '<a href="' + findFileLink(item) + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">View on YouTube</a>';
            } else if (item.vimeoid) {
                itemDisplay = '<div class="ratio ratio-16x9"><iframe src="https://player.vimeo.com/video/' + item.vimeoid + '" allow="autoplay; encrypted-media" allowfullscreen class="embed-responsive-item"></iframe></div>';
                itemDownload = '<a href="' + findFileLink(item) + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">View on Vimeo</a>';
            } else if (item.format.includes('image') || item.format.includes('jpg') || item.format.includes('png') || item.format.includes('gif') || item.filename.includes('.jpg') || item.filename.includes('.png') || item.filename.includes('.gif')) {
                var fileLink = findFileLink(item);
                itemDisplay = fileLink ? '<a href="' + fileLink + '" target="_blank" rel="noopener"><img class="w-100" src="' + fileLink + '" alt="' + item.title + '"></a>' : '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-image }}.svg" alt="No preview found">';
                itemDownload = fileLink ? '<a href="' + fileLink + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download Image</a>' : '';
            } else if (item.format.includes('pdf') || item.filename.includes('.pdf')) {
                var fileLink = findFileLink(item);
                itemDisplay = fileLink ? '<div class="ratio ratio-16x9"><iframe src="' + fileLink + '" allowfullscreen class="embed-responsive-item"></iframe></div>' : '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-pdf }}.svg" alt="No preview found">';
                itemDownload = fileLink ? '<a href="' + fileLink + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download PDF</a>' : '';
            } else if (item.format.includes('audio') || item.filename.includes('.mp3') ) {
                var fileLink = findFileLink(item);
                itemDisplay = fileLink ? '<audio controls preload="metadata"><source src="' + fileLink + '"></audio>' : '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-audio }}.svg" alt="No preview found">';
                itemDownload = fileLink ? '<a href="' + fileLink + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download Audio</a>' : '';
            } else if (item.format.includes('video') || item.filename.includes('.mp4')) {
                var fileLink = findFileLink(item);
                itemDisplay = fileLink ? '<video controls preload="metadata" class="w-100"><source src="' + fileLink + '"></video>' : '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-video }}.svg" alt="No preview found">';
                itemDownload = fileLink ? '<a href="' + fileLink + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download Video</a>' : '';
            } else if (item.format.includes('record')) {
                itemDisplay = item === record ? '' : '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-record }}.svg" alt="No preview found">';
                itemDownload = findFileLink(item) != "" ? '<a href="' + findFileLink(item) + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Link to Object</a>' : '';
            } else {
                /* fall back to no preview if it doesn't know the format */
                itemDisplay = '<img class="w-50" src="{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-default }}.svg" alt="No preview found">';
                itemDownload = '<a href="' + findFileLink(item) + '" target="_blank" rel="noopener" class="btn btn-outline-primary" title="Object download">Download Object</a>';
            }
            if (item === record) { itemImage = itemDisplay; }
        {% else %}
            itemImage = "";
        {% endif %}
        
        /* build button group */
        let compoundObject = compoundObjects.length > 0 ? compoundObjects : [];
        addButtons(item);
        
        /* compose item content */
        var itemContent;
        if (item.format.includes('compound_object') || item.format.includes('multiple')) {
            itemContent = `
            <div class="mb-4">
                ${itemImage}
                <div class="my-2">
                    ${itemLink}
                </div>
            </div>`;
        } else if (item.format.includes('record')) {
            itemContent = `
            <div class="mb-4 text-center">
                <div class="my-2">
                    ${itemLink}
                </div>
            </div>`;
        } else {
            itemContent = `
            <div class="mb-4">
                ${itemImage}
                <div class="my-2">
                    ${itemLink}
                </div>
            </div>`;
        }
        if (item === record) { document.getElementById('item-image').innerHTML = itemContent; }
    };

    /* function to add item metadata */
    function generateMetadata(item) {
        var fields = '<dl>';
        {% for f in fields %}
        {% if f[3] == "iiif" %}
        if (item.iiif_base) { fields += '<dt class="field-name">{{ f[1] }}</dt><dd class="field-value"><a href="' + item.iiif_base + '" target="_blank" rel="noopener">' + item.iiif_base + '</a></dd>'; }
        {% elsif f[3] == "description" %}
        if (item[{{ f[0] | jsonify }}]) { fields += '<dt class="field-name">{{ f[1] }}</dt><dd class="field-value">' + item[{{ f[0] | jsonify }}].replace(/\n\r?/g, '<br/>') + '</dd>'; }
        {% elsif f[2] == "link" %}
        if (item[{{ f[0] | jsonify }}]) { fields += '<dt class="field-name">{{ f[1] }}</dt><dd class="field-value"><a href="' + item[{{ f[0] | jsonify }}] + '" target="_blank" rel="noopener">' + item[{{ f[0] | jsonify }}] + '</a></dd>'; }
        {% elsif f[2] == "array" %}
        if (item[{{ f[0] | jsonify }}]) { 
            let browseLinks = "";
            let browseVals = item[{{ f[0] | jsonify }}].split(';');
            for (let i=0; i<browseVals.length; i++) {
                browseLinks += '<a href="{{ "/browse.html" | relative_url }}?search=' + encodeURIComponent(browseVals[i].trim()) + '">' + browseVals[i].trim() + '</a>';
                if (i !== browseVals.length-1) { browseLinks += '; '; }
            }
            fields += '<dt class="field-name">{{ f[1] }}:</dt> <dd class="field-value">' + browseLinks + '</dd>';
        }
        {% else %}
        if (item[{{ f[0] | jsonify }}]) { fields += '<dt class="field-name">{{ f[1] }}</dt><dd class="field-value">{{ f[2] == "browse" ? "" : "" }}' + item[{{ f[0] | jsonify }}] + '</dd>'; }
        {% endif %}{% endfor %}
        fields += '</dl>';
        return fields;
    };

    /* create compound object cards */
    function compoundItems(compoundItem) {
        var objectCount = Object.keys(compoundItem).length;
        /* set up grid system for compound object cards */
        itemImage = format.includes('compound_object') ? '<div class="row row-cols-2 row-cols-lg-4 g-2">' : "";
        /* set up download dropdown button for compound object page */
        compoundDownload = '<div class="btn-group" role="group"><button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Download</button> <ul class="dropdown-menu">';
        /* generate a modal and card for each item in compound object */
        for (let i = 0; i < compoundItem.length; i++) {
            var compoundLink = findFileLink(compoundItem[i]);
            var compoundThumb = compoundLink ? compoundLink : '{{ "/assets/lib/icons/" | relative_url }}{{ icons.icon-default }}.svg';
            var itemPrev = i === 0 ? compoundItem[compoundItem.length - 1].objectid : compoundItem[i - 1].objectid;
            var itemNext = i + 1 === compoundItem.length ? compoundItem[0].objectid : compoundItem[i + 1].objectid;

            /* create item display and item download link */
            addItem(compoundItem[i]);

            /* create and add timeline button and map button; add item download link button*/
            addButtons(compoundItem[i]);

            /* define media type for stopMedia() function */
            var mediaType;
            if (compoundItem[i].youtubeid) {
                mediaType = "youtube"
            } else if (compoundItem[i].vimeoid) {
                mediaType = "vimeo"
            } else if (compoundItem[i].format.includes('audio') || (compoundItem[i].filename && compoundItem[i].filename.includes('.mp3'))) {
                mediaType = "audio"
            } else if (compoundItem[i].format.includes('video') || (compoundItem[i].filename && compoundItem[i].filename.includes('.mp4'))) {
                mediaType = "video"
            } else if (compoundItem[i].format.includes('pdf') || (compoundItem[i].filename && compoundItem[i].filename.includes('.pdf'))) {
                mediaType = "pdf"
            } else {
                mediaType = "other"
            }

            /* compose compound object card */
            itemImage += `
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <a data-bs-toggle="modal" data-bs-target="#modal-${compoundItem[i].objectid}" href="#">
                        <img src="${compoundThumb}" class="card-img-top" alt="">
                    </a>
                    <div class="card-body">
                        <h3 class="h6 card-title"><a data-bs-toggle="modal" data-bs-target="#modal-${compoundItem[i].objectid}" href="#">${compoundItem[i].title}</a></h3>
                        <div class="small text-muted">${compoundItem[i].date || ""}</div>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group" role="group" aria-label="Compound item options">
                            ${itemLink}
                        </div>
                    </div>
                </div>
            </div>
            `;

            /* create modal for compound object item */
            var modalContent = `
            <div class="modal fade" id="modal-${compoundItem[i].objectid}" tabindex="-1" aria-labelledby="modal-label-${compoundItem[i].objectid}" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="modal-label-${compoundItem[i].objectid}" class="modal-title">${compoundItem[i].title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="stopMedia('${mediaType}', '${compoundItem[i].objectid}')"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">${generateMetadata(compoundItem[i])}</div>
                            <div class="mb-3">${itemImage}</div>
                        </div>
                        <div class="modal-footer">
                            ${itemLink}
                            <a class="btn btn-outline-primary" href="{{ '/item.html' | relative_url }}?id=${compoundItem[i].objectid}">View Item</a>
                            <a class="btn btn-outline-primary" href="{{ '/browse.html' | relative_url }}?id=${compoundItem[i].objectid}">Browse Records</a>
                            <a class="btn btn-outline-primary" href="{{ '/map.html' | relative_url }}?location=${compoundItem[i].latitude},${compoundItem[i].longitude}&marker=${compoundItem[i].objectid}">View on Map</a>
                            <a class="btn btn-outline-primary" href="{{ '/timeline.html' | relative_url }}?date=${compoundItem[i].date}">View on Timeline</a>
                        </div>
                    </div>
                </div>
            </div>`;
            document.getElementById('modals').insertAdjacentHTML('beforeend', modalContent);
        }
        itemImage += format.includes('compound_object') ? '</div>' : '';
        document.getElementById('item-image').innerHTML = itemImage;
    }

    /* find id and display item page */
    var record = cb_items.find( item => item.objectid === itemPageId );
    var format = record.format || "";
    var compoundObject = [];
    if (cb_items.findIndex( item => item.parentid === itemPageId ) != -1 || record.parentid) {
        generateItem(record);
        compoundObject = compoundObjects; 
        compoundItems(compoundObject);
    } else {
        addItem(record);
        document.getElementById('item-image').innerHTML = itemImage;
    }

    /* add item metadata */
    document.getElementById('item-metadata').innerHTML = generateMetadata(record);

    /* previous and next buttons */
    var itemIndex = cb_items.findIndex( item => item.objectid === record.objectid );
    var prevId = itemIndex === 0 ? cb_items[cb_items.length - 1].objectid : cb_items[itemIndex - 1].objectid;
    var nextId = itemIndex + 1 === cb_items.length ? cb_items[0].objectid : cb_items[itemIndex + 1].objectid;
    document.getElementById('prev').href = "{{ '/item.html' | relative_url }}?id=" + prevId;
    document.getElementById('next').href = "{{ '/item.html' | relative_url }}?id=" + nextId;
    /* add side buttons to page */
    document.getElementById('browse').href = "{{ '/browse.html' | relative_url }}?id=" + prevId;
    document.getElementById('files').href = "{{ '/browse.html' | relative_url }}?id=" + nextId;

    /* stop media when modal is closed */
    window.stopMedia = function(type, id) {
        if (type === "youtube") {
            var iframe = document.querySelector("#modal-" + id + " iframe");
            if (iframe) { iframe.contentWindow.postMessage('{"event":"command","func":"stopVideo","args":""}', '*'); }
        } else if (type === "vimeo") {
            var iframe = document.querySelector("#modal-" + id + " iframe");
            if (iframe) { iframe.contentWindow.postMessage('{"method":"pause"}', '*'); }
        } else if (type === "audio" || type === "video") {
            var media = document.querySelector("#modal-" + id + " " + type);
            if (media) { media.pause(); }
        }
    };

})();
</script>
