{% comment %}
  _includes/js/browse-js.html
  - Renderiza tarjetas (cards) para Browse a partir de site.data[site.metadata]
  - Añade botón "Ver ítem" y, si hay coordenadas, "Ver en mapa"
  - Soporta un input de búsqueda con id="browse-q" (opcional)
  - Requiere un contenedor con id="browse-cards"
{% endcomment %}
<script>
(function() {
  // ========= Config =========
  const ITEMS_BASE = "{{ '/items/' | relative_url }}";        // ruta donde viven los item pages
  const MAP_URL    = "{{ '/map.html' | relative_url }}";      // ruta del mapa
  const DATA       = {{ site.data[site.metadata] | jsonify }}; // CSV a objetos JS
  const IMG_FALLBACK = "{{ '/assets/img/placeholder.png' | relative_url }}"; // opcional

  // ========= Utilidades =========
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function asNum(v) {
    if (v === null || v === undefined || v === "") return NaN;
    const n = Number(v);
    return Number.isFinite(n) ? n : NaN;
  }

  function hasCoords(obj) {
    const lat = asNum(obj.latitude);
    const lon = asNum(obj.longitude);
    return Number.isFinite(lat) && Number.isFinite(lon);
  }

  function itemHref(obj) {
    // Prioriza objectid; si no, intenta id; si no, url
    if (obj.objectid) return ITEMS_BASE + encodeURIComponent(String(obj.objectid)) + ".html";
    if (obj.id)       return ITEMS_BASE + encodeURIComponent(String(obj.id)) + ".html";
    if (obj.url)      return obj.url;
    return "#";
  }

  function thumbSrc(obj) {
    // Intenta elegir un thumbnail razonable
    const cand = obj.thumbnail || obj.image_thumb || obj.image || obj.file || "";
    if (cand && String(cand).trim() !== "") return cand;
    return IMG_FALLBACK;
  }

  function subjectsHtml(obj) {
    const raw = obj.subject || obj.keywords || obj.tags || "";
    const arr = Array.isArray(raw) ? raw : String(raw).split(/;|,|\|/).map(s => s.trim()).filter(Boolean);
    if (arr.length === 0) return "";
    return `
      <div class="small text-muted mt-2">
        ${arr.slice(0,6).map(s => `<span class="badge bg-light text-dark border me-1">${escapeHtml(s)}</span>`).join(" ")}
      </div>
    `;
  }

  function buildMapLink(obj) {
    // En OSRS (CRS.Simple) tus "latitude/longitude" son unidades de imagen (px/%) y tu map-js ya lo interpreta.
    // Usamos objectid para abrir popup y location para centrar.
    const lat = String(obj.latitude ?? "").trim();
    const lon = String(obj.longitude ?? "").trim();
    const marker = encodeURIComponent(String(obj.objectid ?? obj.id ?? "").trim());
    if (!lat || !lon || !marker) return null;

    // /map.html?location=<lat>,<lon>&marker=<objectid>
    const href = `${MAP_URL}?location=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&marker=${marker}`;
    return href;
  }

  // ========= Tarjeta =========
  function makeCard(obj) {
    const hrefItem = itemHref(obj);
    const img = thumbSrc(obj);
    const title = escapeHtml(obj.title || "Sin título");
    const creator = escapeHtml(obj.creator || obj.author || "");
    const date = escapeHtml(obj.date || obj.year || "");
    const desc = escapeHtml((obj.description || obj.abstract || "").toString().slice(0, 220));
    const mapHref = hasCoords(obj) ? buildMapLink(obj) : null;

    return `
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <a href="${hrefItem}" class="ratio ratio-4x3">
            <img src="${img}" alt="${title}" class="card-img-top" loading="lazy" style="object-fit:cover;">
          </a>
          <div class="card-body d-flex flex-column">
            <h6 class="card-title mb-1">
              <a href="${hrefItem}" class="stretched-link text-decoration-none">${title}</a>
            </h6>
            ${(creator || date) ? `<div class="small text-muted mb-2">${[creator, date].filter(Boolean).join(" · ")}</div>` : ""}
            ${desc ? `<p class="card-text small mb-2">${desc}${(obj.description && obj.description.length > 220) ? "…" : ""}</p>` : ""}
            ${subjectsHtml(obj)}
            <div class="mt-auto pt-2 d-flex flex-wrap gap-2">
              <a class="btn btn-sm btn-primary" href="${hrefItem}">Ver ítem</a>
              ${mapHref ? `<a class="btn btn-sm btn-outline-primary" href="${mapHref}">Ver en mapa</a>` : ""}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // ========= Render =========
  function render(list) {
    const mount = $("#browse-cards");
    if (!mount) return console.warn("[browse-js] No se encontró #browse-cards.");
    mount.innerHTML = list.map(makeCard).join("");
  }

  // ========= Búsqueda simple (opcional) =========
  function normalize(s) {
    return String(s || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // sin tildes
  }

  function matches(q, obj) {
    if (!q) return true;
    const hay = [
      obj.title, obj.creator, obj.author, obj.description, obj.subject,
      obj.keywords, obj.tags, obj.date, obj.year, obj.location, obj.place,
      obj.objectid, obj.id
    ].map(normalize).join(" ");
    return hay.includes(normalize(q));
  }

  // ========= Pipeline inicial =========
  // Filtra registros vacíos y normaliza un poco
  const ITEMS = DATA
    .filter(d => d && (d.objectid || d.id || d.title))
    // opcional: ordénalos por título
    .sort((a, b) => String(a.title||"").localeCompare(String(b.title||"")));

  render(ITEMS);

  // Hook de búsqueda si existe #browse-q
  const qInput = $("#browse-q");
  if (qInput) {
    qInput.addEventListener("input", function() {
      const q = this.value || "";
      const filtered = ITEMS.filter(it => matches(q, it));
      render(filtered);
    });
  }

})();
</script>
